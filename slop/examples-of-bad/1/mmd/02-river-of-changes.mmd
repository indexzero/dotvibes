%% Diagram 2: The River of Changes
%% _changes feed as continuous stream - like a Twitter timeline, you can scroll back to where you left off
%% Author: As explained by Laurie Voss to a new engineer

flowchart TB
  %% ---- The Change Stream ----
  subgraph Stream["ğŸŒŠ The _changes Feed Timeline"]
    direction TB

    S1["seq:1000<br/>ğŸ“¦ lodash@4.17.20<br/>â° 10:00:00"]
    S2["seq:1001<br/>ğŸ“¦ express@4.18.1<br/>â° 10:00:15"]
    S3["seq:1002<br/>ğŸ’€ left-pad@1.3.0<br/>âŒ DELETED<br/>â° 10:00:30"]
    S4["seq:1003<br/>ğŸ“¦ react@18.2.0<br/>â° 10:00:45"]
    S5["seq:1004<br/>ğŸ“¦ vue@3.3.4<br/>â° 10:01:00"]
    S6["seq:1005<br/>ğŸ“¦ webpack@5.89.0<br/>â° 10:01:15"]
    S7["seq:...<br/>âˆ continues forever"]

    S1 --> S2
    S2 --> S3
    S3 --> S4
    S4 --> S5
    S5 --> S6
    S6 --> S7
  end

  %% ---- Client Subscription ----
  subgraph Client["ğŸ‘€ Your Subscription"]
    C1["ğŸ“ Last checkpoint:<br/>seq:1002<br/><i>'I was here when<br/>left-pad was deleted'</i>"]
    C2["ğŸ”„ Resume Command:<br/><code>GET /_changes?since=1002</code>"]
    C3["ğŸ“¥ Receive:<br/>Changes from seq:1003 onward"]
  end

  S3 -.->|"ğŸ’¾ Save checkpoint"| C1
  C1 --> C2
  C2 -->|"ğŸ“¡ Fetch"| S4
  S4 -.->|"Stream from here"| C3

  %% ---- Key Features ----
  subgraph Features["âœ¨ Key Features"]
    F1["ğŸ“ Strictly Ordered<br/>Every change has unique seq"]
    F2["ğŸ”„ Resumable<br/>Start from any point"]
    F3["ğŸ’€ Deletions Visible<br/>Unpublishes appear as changes"]
    F4["ğŸ¯ Real-time or Polling<br/>continuous=true or false"]
  end

  %% ---- What Happens on Disconnect ----
  subgraph Disconnect["âš¡ Connection Lost?"]
    D1["âŒ Network fails at seq:1004"]
    D2["âœ… No problem!"]
    D3["ğŸ”„ Reconnect with:<br/><code>?since=1004</code>"]
    D4["ğŸ“Š Continue from exact spot"]
  end

  C3 --> D1
  D1 --> D2
  D2 --> D3
  D3 --> D4

  %% ---- Styling ----
  classDef normal     fill:#e1f5e1,stroke:#43a047,stroke-width:2px;
  classDef deleted    fill:#f8d7da,stroke:#dc3545,stroke-width:2px;
  classDef checkpoint fill:#fff3cd,stroke:#ffc107,stroke-width:3px;
  classDef feature    fill:#e3f2fd,stroke:#2196f3,stroke-width:1px;
  classDef disconnect fill:#ffebee,stroke:#f44336,stroke-width:2px;
  classDef stream     fill:#e8f5e9,stroke:#4caf50,stroke-width:1px;

  class S1,S2,S4,S5,S6 normal;
  class S3 deleted;
  class C1 checkpoint;
  class F1,F2,F3,F4 feature;
  class D1,D2,D3,D4 disconnect;
  class S7 stream;