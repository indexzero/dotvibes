%% Diagram 5: B-Tree Balance - Order Matters
%% Like a library - books added in order vs randomly stuffed on shelves
%% Author: As explained by Laurie Voss to a new engineer

flowchart TB
  %% ---- Introduction ----
  subgraph Intro["ğŸ“š Think of a B-Tree Like a Library"]
    I1["Each 'shelf' (node) holds sorted packages<br/>Finding a book is fast when organized<br/>Chaos makes everything slow"]
  end

  %% ---- Sequential Writes (Good) ----
  subgraph Good["ğŸ˜Š Sequential Writes (Balanced Tree)"]
    G_ROOT["ğŸ“š Root Node<br/>(Directory)"]

    G_L1["ğŸ“— Node A<br/>Packages: 1-1000<br/>Depth: 1"]
    G_L2["ğŸ“˜ Node B<br/>Packages: 1001-2000<br/>Depth: 1"]
    G_L3["ğŸ“™ Node C<br/>Packages: 2001-3000<br/>Depth: 1"]

    G_LEAF1["babel<br/>browserify<br/>chai<br/>..."]
    G_LEAF2["express<br/>fastify<br/>gulp<br/>..."]
    G_LEAF3["jest<br/>lodash<br/>mocha<br/>..."]

    G_ROOT --> G_L1
    G_ROOT --> G_L2
    G_ROOT --> G_L3

    G_L1 --> G_LEAF1
    G_L2 --> G_LEAF2
    G_L3 --> G_LEAF3

    G_STATS["âœ… <b>Balanced Tree Stats:</b><br/>â€¢ Depth: 2 levels<br/>â€¢ Lookups: 2 hops max<br/>â€¢ Storage: Optimal<br/>â€¢ Cache hits: 94%"]
  end

  %% ---- Random Writes (Bad) ----
  subgraph Bad["ğŸ˜° Random Writes (Unbalanced Tree)"]
    B_ROOT["ğŸ“š Root Node<br/>(Chaos Directory)"]

    B_L1["ğŸ“• Node X<br/>react, axios, vue<br/>Depth: varies"]
    B_L2["ğŸ““ Node Y<br/>express, zod, babel<br/>Depth: varies"]
    B_L3["ğŸ“” Node Z<br/>lodash, next, jest<br/>Depth: varies"]

    B_DEEP1["ğŸ”€ Fragmented<br/>Data"]
    B_DEEP2["ğŸ”€ More<br/>Fragmentation"]
    B_DEEP3["ğŸ”€ Even More<br/>Fragmentation"]
    B_DEEP4["âš ï¸ Deep<br/>Nesting"]

    B_ROOT --> B_L1
    B_ROOT --> B_L2
    B_ROOT --> B_L3

    B_L1 --> B_DEEP1
    B_L2 --> B_DEEP2
    B_L3 --> B_DEEP3
    B_DEEP1 --> B_DEEP4

    B_STATS["âŒ <b>Unbalanced Tree Stats:</b><br/>â€¢ Depth: 5+ levels<br/>â€¢ Lookups: 5+ hops<br/>â€¢ Storage: Fragmented<br/>â€¢ Cache hits: 72%"]
  end

  Intro --> Good
  Intro --> Bad

  %% ---- npm Registry Reality ----
  subgraph Reality["ğŸ“Š npm Registry: The Real Challenge"]
    R1["<b>450M+ changes</b><br/>across<br/><b>2.5M+ packages</b>"]

    R2["ğŸ“ˆ Update Pattern:<br/>â€¢ Popular packages update frequently<br/>â€¢ Random across entire keyspace<br/>â€¢ No sequential pattern"]

    R3["ğŸ² Example Sequence:<br/>seq:1000 â†’ update 'react'<br/>seq:1001 â†’ update 'left-pad'<br/>seq:1002 â†’ update '@types/node'<br/>= Random tree insertions!"]

    R1 --> R2
    R2 --> R3
  end

  Good --> Reality
  Bad --> Reality

  %% ---- Performance Impact ----
  subgraph Performance["âš¡ Real Performance Impact"]
    P1["<b>Primary Registry (12 years old)</b><br/>â€¢ Built organically over time<br/>â€¢ Tree somewhat optimized<br/>â€¢ 100GB+ database size"]

    P2["<b>New Replica from _changes</b><br/>â€¢ Built from random order<br/>â€¢ Highly fragmented tree<br/>â€¢ Same 100GB+ but slower!"]

    P3["ğŸ“Š <b>Measured Difference:</b><br/>â€¢ Read latency: +40%<br/>â€¢ Write latency: +60%<br/>â€¢ Compaction time: 3x longer<br/>â€¢ Cache efficiency: -22%"]
  end

  Reality --> Performance

  %% ---- Solution ----
  subgraph Solution["ğŸ’¡ The Solution"]
    S1["<b>Best Practice for Replication:</b>"]

    S2["1ï¸âƒ£ <b>Initial Sync:</b><br/>Copy database file directly<br/><code>rsync primary.couch replica.couch</code><br/>Preserves tree structure"]

    S3["2ï¸âƒ£ <b>Incremental Updates:</b><br/>Use _changes feed for new data<br/>Minimal tree disruption"]

    S4["3ï¸âƒ£ <b>Periodic Compaction:</b><br/>Rebuild tree occasionally<br/>Restores balance"]

    S1 --> S2
    S2 --> S3
    S3 --> S4
  end

  Performance --> Solution

  %% ---- Styling ----
  classDef intro      fill:#f0f4ff,stroke:#2196f3,stroke-width:2px;
  classDef good       fill:#d4edda,stroke:#28a745,stroke-width:2px;
  classDef bad        fill:#f8d7da,stroke:#dc3545,stroke-width:2px;
  classDef node       fill:#e3f2fd,stroke:#2196f3,stroke-width:1px;
  classDef leaf       fill:#f5f5f5,stroke:#9e9e9e,stroke-width:1px;
  classDef stats      fill:#fff3cd,stroke:#ffc107,stroke-width:2px;
  classDef reality    fill:#e8f5e9,stroke:#4caf50,stroke-width:2px;
  classDef solution   fill:#e1f5e1,stroke:#43a047,stroke-width:2px;

  class I1 intro;
  class G_ROOT,G_L1,G_L2,G_L3 good;
  class B_ROOT,B_L1,B_L2,B_L3 bad;
  class G_LEAF1,G_LEAF2,G_LEAF3,B_DEEP1,B_DEEP2,B_DEEP3,B_DEEP4 leaf;
  class G_STATS,P3 stats;
  class B_STATS bad;
  class R1,R2,R3 reality;
  class S1,S2,S3,S4 solution;