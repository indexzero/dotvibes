# Diagram 4: npm Tombstones - When Packages Die
# Like a gravestone - marks where something was, with inscription
# Author: As explained by Laurie Voss to a new engineer

direction: down

# The Life and Death of left-pad
lifecycle: "ðŸŽ­ The Life & Death of left-pad" {
  style: {
    fill: "#f8f9fa"
    stroke: "#6c757d"
    stroke-width: 2
  }

  alive: |md
    ðŸ“¦ **left-pad@1.3.0**
    Status: Published
    Size: ~5KB
    Downloads: 2.5M/month
    â° March 2016
  | {
    style: {
      fill: "#d4edda"
      stroke: "#28a745"
      stroke-width: 2
    }
  }

  incident: |md
    ðŸ’¥ **The Incident**
    "11 lines of code
    broke the internet"
  | {
    style: {
      fill: "#fff3cd"
      stroke: "#ffc107"
      stroke-width: 2
    }
  }

  unpublish: |md
    ðŸ—‘ï¸ **npm unpublish**
    Author removes package
  | {
    style: {
      fill: "#ffebee"
      stroke: "#f44336"
      stroke-width: 2
    }
  }

  dead: |md
    ðŸ’€ **left-pad@1.3.0**
    Status: DELETED
    _deleted: true
  | {
    style: {
      fill: "#f8d7da"
      stroke: "#dc3545"
      stroke-width: 3
      font-size: 14
    }
  }

  alive -> incident
  incident -> unpublish
  unpublish -> dead
}

# Normal CouchDB Delete vs npm Tombstone
compare: "âš–ï¸ Normal Delete vs npm Tombstone" {
  style: {
    fill: "#f0f4ff"
    stroke: "#2196f3"
    stroke-width: 2
  }

  normal: |md
    **Normal CouchDB Delete**
    ```json
    {
      "_id": "some-doc",
      "_deleted": true
    }
    ```
    Size: ~100 bytes
    Can be compacted away
  | {
    style: {
      fill: "#e3f2fd"
      stroke: "#2196f3"
    }
  }

  npm_tombstone: |md
    **npm Tombstone**
    ```json
    {
      "_id": "left-pad",
      "_deleted": true,
      "time": {
        "unpublished": {
          "time": "2016-03-23T16:31:23Z",
          "versions": [...],
          "maintainers": [...]
        }
      },
      "_attachments": {
        "readme": {...}
      }
    }
    ```
    Size: 10KB+
    Never goes away!
  | {
    style: {
      fill: "#ffebee"
      stroke: "#c62828"
      stroke-width: 2
    }
  }
}

lifecycle.dead -> compare

# The Tombstone Document
tombstone: "ðŸª¦ The Tombstone Document" {
  style: {
    fill: "#ffebee"
    stroke: "#c62828"
    stroke-width: 2
  }

  header: |md
    **What npm Keeps After Death:**
  | {
    style.font-size: 16
  }

  unpublish_meta: |md
    ðŸ“… **Unpublish Metadata**
    â€¢ When it was unpublished
    â€¢ Who unpublished it
    â€¢ What versions existed
  | {
    style: {
      fill: "#ffebee"
      stroke: "#c62828"
    }
  }

  readme: |md
    ðŸ“„ **README Content**
    â€¢ Documentation remains
    â€¢ So people know what it was
  | {
    style: {
      fill: "#ffebee"
      stroke: "#c62828"
    }
  }

  package_meta: |md
    ðŸ·ï¸ **Package Metadata**
    â€¢ Name is reserved
    â€¢ Can't be reused
  | {
    style: {
      fill: "#ffebee"
      stroke: "#c62828"
    }
  }

  header -> unpublish_meta
  header -> readme
  header -> package_meta
}

compare -> tombstone

# The Change Event
change_event: "ðŸ“¨ The Deletion Change Event" {
  style: {
    fill: "#fffbf0"
    stroke: "#ffc107"
    stroke-width: 2
  }

  event: |md
    ```json
    {
      "seq": "999999",
      "id": "left-pad",
      "deleted": true,
      "changes": [{"rev": "12-xyz"}]
    }
    ```
  | {
    style: {
      fill: "#fff3cd"
      stroke: "#ffc107"
    }
  }

  note: |md
    âš ï¸ **Note:** 'deleted' not '_deleted'
    in the change event
  | {
    style: {
      fill: "#fff3cd"
      stroke: "#ffc107"
      font-style: italic
    }
  }

  event -> note
}

tombstone -> change_event

# Why This Matters
impact: "âš ï¸ Why Tombstones Matter" {
  style: {
    fill: "#ffebee"
    stroke: "#f44336"
    stroke-width: 2
  }

  size: |md
    **ðŸ“ Size Impact**
    Tombstone: 10KB+
    vs Normal delete: 100 bytes
    100x larger!
  | {
    style: {
      fill: "#ffebee"
      stroke: "#f44336"
    }
  }

  btree: |md
    **ðŸŒ² B-Tree Impact**
    Deleted nodes still consume space
    Can't be compacted
    Tree stays unbalanced
  | {
    style: {
      fill: "#ffebee"
      stroke: "#f44336"
    }
  }

  replication: |md
    **ðŸ’¾ Replication Impact**
    Every replica carries
    all tombstones forever
    Disk usage never decreases
  | {
    style: {
      fill: "#ffebee"
      stroke: "#f44336"
    }
  }

  security: |md
    **ðŸ”’ Security/Legal**
    Preserves unpublish history
    Prevents name hijacking
    Audit trail
  | {
    style: {
      fill: "#ffebee"
      stroke: "#f44336"
    }
  }
}

change_event -> impact

# Real World Example
realworld: "ðŸ“Š npm Registry Reality" {
  style: {
    fill: "#e3f2fd"
    stroke: "#2196f3"
    stroke-width: 2
  }

  stats: |md
    **Current Stats (2024):**
    ~2.5M packages total
    ~100K unpublished packages
    = ~1GB of tombstones
  | {
    style: {
      fill: "#e3f2fd"
      stroke: "#2196f3"
    }
  }

  famous: |md
    **Famous Tombstones:**
    â€¢ left-pad
    â€¢ kik
    â€¢ node-ipc
    â€¢ colors.js
    â€¢ faker.js
  | {
    style: {
      fill: "#e3f2fd"
      stroke: "#2196f3"
    }
  }

  lesson: |md
    **Lesson:**
    Once published to npm,
    it never truly goes away
  | {
    style: {
      fill: "#e3f2fd"
      stroke: "#2196f3"
      font-size: 14
      font-weight: bold
    }
  }

  stats -> famous
  famous -> lesson
}

impact -> realworld