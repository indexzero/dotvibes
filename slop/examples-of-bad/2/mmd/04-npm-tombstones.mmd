%% Diagram 4: npm Tombstones Structure

flowchart LR
  subgraph Delete["npm unpublish"]
    LIVE["left-pad@1.3.0<br/>Published"]
    DEAD["left-pad@1.3.0<br/>Deleted"]
    LIVE -->|"unpublish"| DEAD
  end

  subgraph Compare["Document Structure"]
    NORMAL["Normal Delete:<br/>{<br/>  _id: 'some-doc',<br/>  _deleted: true<br/>}<br/>~100 bytes"]

    TOMBSTONE["npm Tombstone:<br/>{<br/>  _id: 'left-pad',<br/>  _deleted: true,<br/>  time: {<br/>    unpublished: {...}<br/>  },<br/>  _attachments: {<br/>    readme: {...}<br/>  }<br/>}<br/>~10KB+"]
  end

  DEAD --> Compare

  subgraph Change["Change Event"]
    CE["{<br/>  seq: '999999',<br/>  id: 'left-pad',<br/>  deleted: true,<br/>  changes: [{rev: '12-xyz'}]<br/>}"]
  end

  TOMBSTONE --> CE

  subgraph Impact["Impact"]
    I1["100x larger than normal delete"]
    I2["Cannot be compacted"]
    I3["Preserved forever in replicas"]
  end

  CE --> Impact

  classDef alive fill:#d4edda,stroke:#28a745,stroke-width:2px;
  classDef dead fill:#f8d7da,stroke:#dc3545,stroke-width:3px;
  classDef change fill:#fff3cd,stroke:#ffc107,stroke-width:2px;

  class LIVE alive;
  class DEAD,TOMBSTONE dead;
  class CE,NORMAL change;