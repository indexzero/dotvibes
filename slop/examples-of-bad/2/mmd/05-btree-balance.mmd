%% Diagram 5: B-Tree Balance Impact

flowchart TB
  subgraph Sequential["Sequential _changes Order"]
    S_TREE["Balanced B-Tree<br/>Depth: 2-3<br/>Uniform distribution"]
    S_PERF["Read: fast<br/>Cache: 94% hits<br/>Compact: efficient"]
    S_TREE --> S_PERF
  end

  subgraph Random["Random _changes Order"]
    R_TREE["Fragmented B-Tree<br/>Depth: 5-7<br/>Uneven distribution"]
    R_PERF["Read: +40% slower<br/>Cache: 72% hits<br/>Compact: 3x longer"]
    R_TREE --> R_PERF
  end

  subgraph NPM["npm Reality"]
    CHANGES["450M+ changes<br/>Random package updates"]
    EXAMPLE["seq:1000 → 'react'<br/>seq:1001 → 'left-pad'<br/>seq:1002 → '@types/node'"]
    CHANGES --> EXAMPLE
  end

  Sequential --> NPM
  Random --> NPM

  subgraph Solution["Replication Strategy"]
    RSYNC["Initial: rsync primary.couch replica.couch"]
    INCR["Incremental: GET /_changes?since=..."]
    COMPACT["Periodic: POST /_compact"]
    RSYNC --> INCR
    INCR --> COMPACT
  end

  NPM --> Solution

  classDef good fill:#d4edda,stroke:#28a745,stroke-width:2px;
  classDef bad fill:#f8d7da,stroke:#dc3545,stroke-width:2px;
  classDef reality fill:#e8f5e9,stroke:#4caf50,stroke-width:2px;
  classDef solution fill:#fff3cd,stroke:#ffc107,stroke-width:2px;

  class S_TREE,S_PERF good;
  class R_TREE,R_PERF bad;
  class CHANGES,EXAMPLE reality;
  class RSYNC,INCR,COMPACT solution;