# Diagram 5: B-Tree Balance - Order Matters
# Like a library - books added in order vs randomly stuffed on shelves
# Author: As explained by Laurie Voss to a new engineer

direction: down

# Introduction
intro: "ðŸ“š Think of a B-Tree Like a Library" {
  style: {
    fill: "#f0f4ff"
    stroke: "#2196f3"
    stroke-width: 2
  }

  explanation: |md
    Each 'shelf' (node) holds sorted packages
    Finding a book is fast when organized
    Chaos makes everything slow
  | {
    style.font-size: 14
  }
}

# Container for both tree types
trees: "" {
  style.fill: transparent
  style.stroke: none

  # Sequential Writes (Good)
  good: "ðŸ˜Š Sequential Writes (Balanced Tree)" {
    style: {
      fill: "#e8f5e9"
      stroke: "#28a745"
      stroke-width: 2
    }

    root: |md
      ðŸ“š **Root Node**
      (Directory)
    | {
      style: {
        fill: "#d4edda"
        stroke: "#28a745"
        stroke-width: 2
      }
    }

    nodeA: |md
      ðŸ“— **Node A**
      Packages: 1-1000
      Depth: 1
    | {
      style: {
        fill: "#e3f2fd"
        stroke: "#2196f3"
      }
    }

    nodeB: |md
      ðŸ“˜ **Node B**
      Packages: 1001-2000
      Depth: 1
    | {
      style: {
        fill: "#e3f2fd"
        stroke: "#2196f3"
      }
    }

    nodeC: |md
      ðŸ“™ **Node C**
      Packages: 2001-3000
      Depth: 1
    | {
      style: {
        fill: "#e3f2fd"
        stroke: "#2196f3"
      }
    }

    leafA: |md
      babel
      browserify
      chai
      ...
    | {
      style: {
        fill: "#f5f5f5"
        stroke: "#9e9e9e"
      }
    }

    leafB: |md
      express
      fastify
      gulp
      ...
    | {
      style: {
        fill: "#f5f5f5"
        stroke: "#9e9e9e"
      }
    }

    leafC: |md
      jest
      lodash
      mocha
      ...
    | {
      style: {
        fill: "#f5f5f5"
        stroke: "#9e9e9e"
      }
    }

    root -> nodeA
    root -> nodeB
    root -> nodeC
    nodeA -> leafA
    nodeB -> leafB
    nodeC -> leafC

    stats: |md
      âœ… **Balanced Tree Stats:**
      â€¢ Depth: 2 levels
      â€¢ Lookups: 2 hops max
      â€¢ Storage: Optimal
      â€¢ Cache hits: 94%
    | {
      style: {
        fill: "#d4edda"
        stroke: "#28a745"
        stroke-width: 2
        font-size: 14
      }
    }
  }

  # Random Writes (Bad)
  bad: "ðŸ˜° Random Writes (Unbalanced Tree)" {
    style: {
      fill: "#ffebee"
      stroke: "#dc3545"
      stroke-width: 2
    }

    root: |md
      ðŸ“š **Root Node**
      (Chaos Directory)
    | {
      style: {
        fill: "#f8d7da"
        stroke: "#dc3545"
        stroke-width: 2
      }
    }

    nodeX: |md
      ðŸ“• **Node X**
      react, axios, vue
      Depth: varies
    | {
      style: {
        fill: "#ffcdd2"
        stroke: "#f44336"
      }
    }

    nodeY: |md
      ðŸ““ **Node Y**
      express, zod, babel
      Depth: varies
    | {
      style: {
        fill: "#ffcdd2"
        stroke: "#f44336"
      }
    }

    nodeZ: |md
      ðŸ“” **Node Z**
      lodash, next, jest
      Depth: varies
    | {
      style: {
        fill: "#ffcdd2"
        stroke: "#f44336"
      }
    }

    frag1: |md
      ðŸ”€ Fragmented
      Data
    | {
      style: {
        fill: "#f5f5f5"
        stroke: "#9e9e9e"
      }
    }

    frag2: |md
      ðŸ”€ More
      Fragmentation
    | {
      style: {
        fill: "#f5f5f5"
        stroke: "#9e9e9e"
      }
    }

    frag3: |md
      ðŸ”€ Even More
      Fragmentation
    | {
      style: {
        fill: "#f5f5f5"
        stroke: "#9e9e9e"
      }
    }

    deep: |md
      âš ï¸ Deep
      Nesting
    | {
      style: {
        fill: "#ffebee"
        stroke: "#f44336"
      }
    }

    root -> nodeX
    root -> nodeY
    root -> nodeZ
    nodeX -> frag1
    nodeY -> frag2
    nodeZ -> frag3
    frag1 -> deep

    stats: |md
      âŒ **Unbalanced Tree Stats:**
      â€¢ Depth: 5+ levels
      â€¢ Lookups: 5+ hops
      â€¢ Storage: Fragmented
      â€¢ Cache hits: 72%
    | {
      style: {
        fill: "#f8d7da"
        stroke: "#dc3545"
        stroke-width: 2
        font-size: 14
      }
    }
  }
}

intro -> trees

# npm Registry Reality
reality: "ðŸ“Š npm Registry: The Real Challenge" {
  style: {
    fill: "#e8f5e9"
    stroke: "#4caf50"
    stroke-width: 2
  }

  scale: |md
    **450M+ changes**
    across
    **2.5M+ packages**
  | {
    style: {
      fill: "#e8f5e9"
      stroke: "#4caf50"
      font-size: 16
    }
  }

  pattern: |md
    ðŸ“ˆ **Update Pattern:**
    â€¢ Popular packages update frequently
    â€¢ Random across entire keyspace
    â€¢ No sequential pattern
  | {
    style: {
      fill: "#e8f5e9"
      stroke: "#4caf50"
    }
  }

  example: |md
    ðŸŽ² **Example Sequence:**
    seq:1000 â†’ update 'react'
    seq:1001 â†’ update 'left-pad'
    seq:1002 â†’ update '@types/node'
    = Random tree insertions!
  | {
    style: {
      fill: "#e8f5e9"
      stroke: "#4caf50"
    }
  }

  scale -> pattern -> example
}

trees -> reality

# Performance Impact
performance: "âš¡ Real Performance Impact" {
  style: {
    fill: "#fff3cd"
    stroke: "#ffc107"
    stroke-width: 2
  }

  primary: |md
    **Primary Registry (12 years old)**
    â€¢ Built organically over time
    â€¢ Tree somewhat optimized
    â€¢ 100GB+ database size
  | {
    style: {
      fill: "#fff3cd"
      stroke: "#ffc107"
    }
  }

  replica: |md
    **New Replica from _changes**
    â€¢ Built from random order
    â€¢ Highly fragmented tree
    â€¢ Same 100GB+ but slower!
  | {
    style: {
      fill: "#ffebee"
      stroke: "#f44336"
    }
  }

  measured: |md
    ðŸ“Š **Measured Difference:**
    â€¢ Read latency: +40%
    â€¢ Write latency: +60%
    â€¢ Compaction time: 3x longer
    â€¢ Cache efficiency: -22%
  | {
    style: {
      fill: "#fff3cd"
      stroke: "#ffc107"
      font-size: 14
    }
  }

  primary -> replica -> measured
}

reality -> performance

# Solution
solution: "ðŸ’¡ The Solution" {
  style: {
    fill: "#e1f5e1"
    stroke: "#43a047"
    stroke-width: 2
  }

  header: |md
    **Best Practice for Replication:**
  | {
    style.font-size: 16
  }

  step1: |md
    1ï¸âƒ£ **Initial Sync:**
    Copy database file directly
    `rsync primary.couch replica.couch`
    Preserves tree structure
  | {
    style: {
      fill: "#e1f5e1"
      stroke: "#43a047"
    }
  }

  step2: |md
    2ï¸âƒ£ **Incremental Updates:**
    Use _changes feed for new data
    Minimal tree disruption
  | {
    style: {
      fill: "#e1f5e1"
      stroke: "#43a047"
    }
  }

  step3: |md
    3ï¸âƒ£ **Periodic Compaction:**
    Rebuild tree occasionally
    Restores balance
  | {
    style: {
      fill: "#e1f5e1"
      stroke: "#43a047"
    }
  }

  header -> step1 -> step2 -> step3
}

performance -> solution